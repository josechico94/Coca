<!doctype html>
<html lang="es" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Planificador de Rutas ‚Äî Beta</title>

  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * { font-family: 'DM Sans', sans-serif; }
    html, body { height: 100%; }
    body { overflow: hidden; box-sizing: border-box; }
    .leaflet-container { background: #0b1220; }

    /* Scrollbar */
    .nice-scroll::-webkit-scrollbar { width: 10px; }
    .nice-scroll::-webkit-scrollbar-track { background: rgba(148,163,184,0.08); border-radius: 999px; }
    .nice-scroll::-webkit-scrollbar-thumb { background: rgba(148,163,184,0.25); border-radius: 999px; }
    .nice-scroll::-webkit-scrollbar-thumb:hover { background: rgba(148,163,184,0.35); }

    .custom-marker {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      border: 3px solid #fff;
      border-radius: 50%;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
      width: 24px; height: 24px;
    }
    .selected-marker {
      background: linear-gradient(135deg, #f59e0b, #ef4444) !important;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.1)} }

    .toast { animation: slideIn 0.25s ease-out; }
    @keyframes slideIn { from{transform:translateX(100%);opacity:0} to{transform:translateX(0);opacity:1} }

    .address-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
    .btn-primary { background: linear-gradient(135deg, #6366f1, #8b5cf6); transition: all 0.2s ease; }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(99, 102, 241, 0.35); }

    .dragging { opacity: 0.55; }
    .drop-hint { outline: 2px dashed rgba(99,102,241,0.9); outline-offset: 2px; }

    .suggestions {
      position: absolute; z-index: 60; width: 100%;
      max-height: 240px; overflow: auto;
      border-radius: 14px; border: 1px solid rgba(148,163,184,0.25);
      background: rgba(15,23,42,0.95); backdrop-filter: blur(10px);
      box-shadow: 0 16px 45px rgba(0,0,0,0.45);
    }
    .suggestions button { display:block; width:100%; text-align:left; padding:10px 12px; font-size: 13px; }
    .suggestions button:hover { background: rgba(99,102,241,0.12); }

    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body class="h-full bg-slate-900 text-white overflow-hidden">
  <div id="app" class="h-full flex flex-col">
    <!-- Header -->
    <header class="bg-slate-800/80 backdrop-blur-lg border-b border-slate-700 px-4 py-3 flex items-center justify-between flex-shrink-0">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
          </svg>
        </div>
        <h1 class="text-xl font-bold bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">
          Planificador de Rutas ‚Äî Beta
        </h1>
      </div>

      <div class="flex items-center gap-2">
        <span id="address-count" class="text-sm text-slate-400">0 direcciones</span>
        <button id="toggle-panel" class="lg:hidden p-2 rounded-lg bg-slate-700 hover:bg-slate-600" title="Abrir panel">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>
    </header>

    <!-- Main -->
    <main class="flex-1 flex overflow-hidden relative">
      <!-- Backdrop mobile -->
      <div id="sidebar-backdrop" class="fixed inset-0 bg-black/60 z-40 hidden lg:hidden"></div>

      <!-- Sidebar (FIXED on mobile) -->
      <aside id="sidebar"
        class="fixed lg:relative inset-y-0 left-0
               w-[min(420px,92vw)] lg:w-[420px]
               bg-slate-800/80 backdrop-blur
               border-r border-slate-700
               flex flex-col overflow-hidden
               z-50
               transform -translate-x-full lg:translate-x-0
               transition-transform duration-200 ease-out">

        <!-- Scroll container -->
        <div id="sidebar-scroll" class="flex-1 overflow-y-auto nice-scroll">
          <!-- Add Address -->
          <div class="p-4 border-b border-slate-700">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-sm font-semibold text-slate-400 uppercase tracking-wider">Nueva Direcci√≥n</h2>
              <div class="flex gap-2">
                <button id="backup-btn" class="text-xs px-2 py-1 rounded-lg bg-slate-700 hover:bg-slate-600 text-slate-200">
                  Backup JSON
                </button>
                <button id="clear-all-btn" class="text-xs px-2 py-1 rounded-lg bg-slate-700 hover:bg-slate-600 text-slate-200">
                  Limpiar todo
                </button>
              </div>
            </div>

            <form id="address-form" class="space-y-3 relative">
              <div class="relative">
                <input type="text" id="address-input" placeholder="Direcci√≥n completa..."
                  class="w-full px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-xl focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/20 transition-all" />
                <div id="address-suggestions" class="suggestions hidden mt-2"></div>
              </div>

              <div class="grid grid-cols-2 gap-3">
                <input type="text" id="zone-input" placeholder="Zona"
                  class="px-4 py-2.5 bg-slate-700/50 border border-slate-600 rounded-xl focus:outline-none focus:border-indigo-500 transition-all" />
                <input type="text" id="postal-input" placeholder="C√≥digo Postal"
                  class="px-4 py-2.5 bg-slate-700/50 border border-slate-600 rounded-xl focus:outline-none focus:border-indigo-500 transition-all" />
              </div>

              <button type="submit" class="w-full py-3 btn-primary text-white font-semibold rounded-xl flex items-center justify-center gap-2">
                <span>Agregar Direcci√≥n</span>
              </button>
            </form>

            <div class="grid grid-cols-2 gap-2 mt-3">
              <button id="toggle-import-form"
                class="py-2.5 bg-slate-700 hover:bg-slate-600 text-white font-semibold rounded-xl transition-all text-sm">
                Importar CSV/Excel
              </button>

              <label class="py-2.5 bg-slate-700 hover:bg-slate-600 text-white font-semibold rounded-xl transition-all text-sm flex items-center justify-center cursor-pointer">
                <input id="restore-input" type="file" accept=".json" class="hidden" />
                Restaurar JSON
              </label>
            </div>

            <label class="flex items-center gap-2 text-xs text-slate-300 mt-3">
              <input type="checkbox" id="append-bologna" class="accent-indigo-500" checked />
              Autocompletar geocode: agregar ‚Äú, Bologna, Italia‚Äù si no est√°
            </label>

            <p class="text-xs text-slate-500 mt-2">
              Se guarda en tu navegador (localStorage). Cache de geocoding activado.
            </p>
          </div>

          <!-- Import -->
          <div id="import-form-section" class="p-4 border-b border-slate-700 hidden">
            <h2 class="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-3">Importar Direcciones</h2>
            <div class="space-y-3">
              <div class="border-2 border-dashed border-slate-600 rounded-xl p-4 text-center cursor-pointer hover:border-indigo-500 transition-all"
                id="drop-zone">
                <p class="text-sm font-medium">Arrastra tu archivo aqu√≠</p>
                <p class="text-xs text-slate-400 mt-1">O haz clic para seleccionar</p>
                <input type="file" id="file-input" accept=".csv,.xlsx,.xls" class="hidden" />
              </div>

              <div id="file-preview" class="hidden bg-slate-700/50 rounded-xl p-3">
                <p class="text-sm font-medium mb-2">
                  Archivo: <span id="file-name" class="text-indigo-400"></span>
                </p>

                <div class="space-y-2">
                  <select id="address-column" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-sm">
                    <option value="">Columna Direcci√≥n</option>
                  </select>
                  <select id="zone-column" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-sm">
                    <option value="">Columna Zona (opcional)</option>
                  </select>
                  <select id="postal-column" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-sm">
                    <option value="">Columna C√≥digo Postal (opcional)</option>
                  </select>
                </div>

                <div class="flex gap-2 mt-3">
                  <button type="button" id="import-btn"
                    class="flex-1 py-2.5 bg-emerald-500 hover:bg-emerald-600 text-white font-semibold rounded-lg transition-all text-sm">
                    Importar
                  </button>
                  <button type="button" id="cancel-import-btn"
                    class="flex-1 py-2.5 bg-slate-600 hover:bg-slate-500 text-white font-semibold rounded-lg transition-all text-sm">
                    Cancelar
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Filters -->
          <div class="p-4 border-b border-slate-700">
            <h2 class="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-3">Filtros</h2>
            <div class="space-y-3">
              <select id="zone-filter" class="w-full px-4 py-2.5 bg-slate-700/50 border border-slate-600 rounded-xl">
                <option value="">Todas las zonas</option>
              </select>

              <select id="postal-filter" class="w-full px-4 py-2.5 bg-slate-700/50 border border-slate-600 rounded-xl">
                <option value="">Todos los c√≥digos postales</option>
              </select>

              <div>
                <label class="text-sm text-slate-400 mb-1 block">Radio: <span id="distance-value">50</span> km</label>
                <input type="range" id="distance-filter" min="1" max="100" value="50"
                  class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-indigo-500">
              </div>

              <button id="reset-filters" class="w-full py-2.5 bg-slate-700 hover:bg-slate-600 rounded-xl font-semibold transition-all text-sm">
                Reset filtros
              </button>
            </div>
          </div>

          <!-- Route Planner -->
          <div class="p-4 border-b border-slate-700">
            <div class="flex items-center justify-between mb-2">
              <h2 class="text-sm font-semibold text-slate-400 uppercase tracking-wider">Percorso</h2>
              <span id="selected-count" class="text-xs px-2 py-1 bg-indigo-500/20 text-indigo-400 rounded-full">0/10</span>
            </div>

            <p class="text-xs text-slate-500 mb-3">
              Eleg√≠ inicio/fin, seleccion√° puntos y luego optimiz√° o calcul√° en tu orden.
            </p>

            <div class="grid grid-cols-2 gap-2 mb-3">
              <div class="relative">
                <label class="text-xs text-slate-400">Inicio</label>
                <select id="start-select" class="w-full mt-1 px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-sm">
                  <option value="">Seleccionar...</option>
                  <option value="__GEO__">üìç Mi ubicaci√≥n</option>
                  <option value="__NEW__">Nueva direcci√≥n...</option>
                </select>
                <input id="start-new" type="text"
                  class="hidden w-full mt-2 px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-sm"
                  placeholder="Inicio (ej: Via Rizzoli 1)" />
                <div id="start-suggestions" class="suggestions hidden mt-2"></div>
              </div>

              <div class="relative">
                <label class="text-xs text-slate-400">Fin</label>
                <select id="end-select" class="w-full mt-1 px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-sm">
                  <option value="">Seleccionar...</option>
                  <option value="__GEO__">üìç Mi ubicaci√≥n</option>
                  <option value="__NEW__">Nueva direcci√≥n...</option>
                </select>
                <input id="end-new" type="text"
                  class="hidden w-full mt-2 px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-sm"
                  placeholder="Fin" />
                <div id="end-suggestions" class="suggestions hidden mt-2"></div>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-2">
              <button id="optimize-route-btn"
                class="py-2.5 bg-emerald-500 hover:bg-emerald-600 text-white font-semibold rounded-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                disabled>
                Optimizar
              </button>
              <button id="calc-route-btn"
                class="py-2.5 bg-slate-700 hover:bg-slate-600 text-white font-semibold rounded-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                disabled>
                Calcular
              </button>
            </div>

            <div class="flex gap-2 mt-2">
              <button id="clear-route-btn" class="flex-1 py-2.5 bg-slate-700 hover:bg-slate-600 rounded-xl font-semibold transition-all text-sm">
                Limpiar selecci√≥n/ruta
              </button>
            </div>

            <div class="flex gap-2 mt-3">
              <button id="export-gpx-btn" class="flex-1 py-2.5 bg-slate-700 hover:bg-slate-600 rounded-xl font-semibold transition-all text-sm disabled:opacity-50" disabled>
                Export GPX
              </button>
              <button id="export-kml-btn" class="flex-1 py-2.5 bg-slate-700 hover:bg-slate-600 rounded-xl font-semibold transition-all text-sm disabled:opacity-50" disabled>
                Export KML
              </button>
            </div>
          </div>

          <!-- Route order -->
          <div class="p-4 border-b border-slate-700">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wider">Orden de visita</h3>
              <span class="text-xs text-slate-500">Drag & drop</span>
            </div>
            <div id="route-order" class="space-y-2">
              <p class="text-xs text-slate-500">Seleccion√° direcciones para armar el orden ac√°.</p>
            </div>
          </div>

          <!-- Address List -->
          <div class="p-4">
            <h2 class="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-3">Direcciones</h2>
            <div id="address-list" class="space-y-2"></div>
          </div>
        </div>
      </aside>

      <!-- Map -->
      <div class="flex-1 relative">
        <div id="map" class="absolute inset-0"></div>

        <!-- Route info panel -->
        <div id="route-info"
          class="absolute top-4 right-4 bg-slate-800/90 backdrop-blur-lg rounded-2xl p-4 shadow-xl border border-slate-700 hidden w-[320px] z-30">
          <div class="flex items-center justify-between gap-2 mb-2">
            <h3 class="font-bold text-lg">Ruta</h3>
            <button id="open-gmaps-btn" class="text-xs px-2 py-1 rounded-lg bg-slate-700 hover:bg-slate-600">
              Google Maps
            </button>
          </div>
          <div id="route-details" class="text-sm text-slate-300 space-y-1"></div>
        </div>

        <!-- Navigation panel (placeholder UI) -->
        <div id="nav-panel"
          class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-slate-800/90 backdrop-blur-lg rounded-2xl p-4 shadow-xl border border-slate-700 hidden w-[min(760px,calc(100vw-32px))] z-30">
          <div class="flex items-center justify-between gap-3">
            <div class="min-w-0">
              <p class="text-xs text-slate-400">Navegaci√≥n</p>
              <p id="nav-next" class="font-semibold truncate">‚Äî</p>
              <p id="nav-sub" class="text-xs text-slate-400">‚Äî</p>
            </div>
            <div class="flex gap-2 flex-shrink-0">
              <button id="nav-start-btn" class="px-3 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 font-semibold text-sm">Start</button>
              <button id="nav-sim-btn" class="px-3 py-2 rounded-xl bg-indigo-500 hover:bg-indigo-600 font-semibold text-sm">Simular</button>
              <button id="nav-stop-btn" class="px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 font-semibold text-sm">Stop</button>
              <button id="nav-toggle-steps" class="px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 font-semibold text-sm">Pasos</button>
            </div>
          </div>

          <div class="mt-3">
            <div class="w-full h-2 bg-slate-700 rounded-full overflow-hidden">
              <div id="nav-progress" class="h-2 bg-emerald-500 w-0"></div>
            </div>
          </div>

          <div id="nav-steps" class="hidden mt-3 max-h-[180px] overflow-auto rounded-xl border border-slate-700 bg-slate-900/40 nice-scroll">
            <div id="nav-steps-inner" class="p-3 space-y-2 text-sm"></div>
          </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loading" class="absolute inset-0 bg-slate-900/75 backdrop-blur flex items-center justify-center hidden z-40">
          <div class="bg-slate-800/80 border border-slate-700 rounded-2xl p-6 w-[min(420px,calc(100vw-32px))] shadow-2xl">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
              <div class="min-w-0">
                <p id="loading-text" class="text-slate-100 font-semibold text-base">Procesando‚Ä¶</p>
                <p id="loading-sub" class="text-xs text-slate-400 mt-1 truncate">‚Äî</p>
              </div>
            </div>
            <div class="mt-4 text-xs text-slate-400">
              <span class="text-slate-300">Tip:</span> importar muchas direcciones puede tardar por l√≠mites de geocoding.
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Toast -->
    <div id="toast-container" class="fixed bottom-4 right-4 space-y-2 z-[70]"></div>

    <!-- Delete Modal -->
    <div id="delete-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[80] hidden">
      <div class="bg-slate-800 rounded-2xl p-6 max-w-sm mx-4 border border-slate-700 shadow-2xl">
        <h3 class="text-lg font-bold text-center mb-2">¬øEliminar direcci√≥n?</h3>
        <p id="delete-address-text" class="text-sm text-slate-400 text-center mb-6">Esta acci√≥n no se puede deshacer.</p>
        <div class="flex gap-3">
          <button id="cancel-delete" class="flex-1 py-2.5 bg-slate-700 hover:bg-slate-600 rounded-xl font-semibold transition-all">Cancelar</button>
          <button id="confirm-delete" class="flex-1 py-2.5 bg-red-500 hover:bg-red-600 rounded-xl font-semibold transition-all">Eliminar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========= CONFIG =========
    const config = {
      maxAddresses: 999,
      maxRoutePoints: 10,
      importGeocodeDelayMs: 850,
      defaultCenter: [44.4949, 11.3426],
      defaultZoom: 13,
      storageKey: "route_planner_beta_v2_state",
      geocodeCacheKey: "route_planner_beta_v2_geocode_cache",
      autocompleteDelayMs: 250
    };

    // ========= STATE =========
    let addresses = [];
    let selectedIds = [];
    let visitOrderIds = [];
    let markers = {};
    let map = null;

    let routeLayer = null;
    let routeNumberMarkers = [];
    let deleteTargetId = null;
    let importedData = null;

    let startPoint = null;
    let endPoint = null;
    let lastOrderedRoutePoints = null;

    let geocodeCache = {};
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    // ========= UX helpers =========
    function setLoading(isLoading, text = "Procesando...", sub = "") {
      document.getElementById("loading-text").textContent = text;
      document.getElementById("loading-sub").textContent = sub || "‚Äî";
      document.getElementById("loading").classList.toggle("hidden", !isLoading);
    }

    function setButtonLoading(btn, loading, labelWhenDone) {
      if (!btn) return;
      if (loading) {
        btn.dataset.prev = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = `<span class="inline-flex items-center gap-2">
          <span class="w-4 h-4 border-2 border-white/80 border-t-transparent rounded-full animate-spin"></span>
          <span>Calculando‚Ä¶</span>
        </span>`;
      } else {
        btn.disabled = false;
        btn.innerHTML = labelWhenDone ?? (btn.dataset.prev || btn.innerHTML);
      }
    }

    function showToast(message, type = "info") {
      const container = document.getElementById("toast-container");
      const toast = document.createElement("div");
      const colors = {
        success: "bg-emerald-500",
        error: "bg-red-500",
        warning: "bg-amber-500",
        info: "bg-indigo-500"
      };
      toast.className = `toast ${colors[type] || colors.info} text-white px-4 py-3 rounded-xl shadow-lg`;
      toast.innerHTML = `<span class="text-sm">${escapeHtml(message)}</span>`;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3200);
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
    function escapeAttr(str) { return escapeHtml(str).replaceAll("`", "&#096;"); }

    // ========= Distance =========
    function getDistanceKm(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) ** 2 +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // ========= Geocoding =========
    function normalizeAddressForGeocode(addr) {
      const shouldAppend = document.getElementById("append-bologna")?.checked ?? true;
      if (!shouldAppend) return addr;
      const low = addr.toLowerCase();
      if (low.includes("bologna") || low.includes("italia") || low.includes("italy")) return addr;
      return `${addr}, Bologna, Italia`;
    }

    async function geocodeAddress(query) {
      const q = query.trim();
      if (!q) return null;
      if (geocodeCache[q]) return geocodeCache[q];

      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`;
      const res = await fetch(url, { headers: { "Accept": "application/json" } });
      if (!res.ok) return null;
      const data = await res.json();
      if (data && data.length) {
        const coords = { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
        geocodeCache[q] = coords;
        saveGeocodeCache();
        return coords;
      }
      return null;
    }

    async function searchAutocomplete(query) {
      const q = query.trim();
      if (!q || q.length < 3) return [];
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&addressdetails=1&limit=6`;
      const res = await fetch(url, { headers: { "Accept": "application/json" } });
      if (!res.ok) return [];
      const data = await res.json();
      return (data || []).map(d => ({ label: d.display_name, lat: parseFloat(d.lat), lng: parseFloat(d.lon) }));
    }

    // ========= Persistence =========
    function saveState() {
      try { localStorage.setItem(config.storageKey, JSON.stringify({ addresses })); } catch {}
    }
    function loadState() {
      try {
        const raw = localStorage.getItem(config.storageKey);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed?.addresses)) addresses = parsed.addresses;
      } catch {}
    }
    function saveGeocodeCache() {
      try { localStorage.setItem(config.geocodeCacheKey, JSON.stringify(geocodeCache)); } catch {}
    }
    function loadGeocodeCache() {
      try {
        const raw = localStorage.getItem(config.geocodeCacheKey);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (parsed && typeof parsed === "object") geocodeCache = parsed;
      } catch {}
    }

    // ========= Map =========
    function initMap() {
      map = L.map("map", { center: config.defaultCenter, zoom: config.defaultZoom, zoomControl: true });
      L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
        attribution: "&copy; OpenStreetMap contributors &copy; CARTO",
        subdomains: "abcd",
        maxZoom: 20
      }).addTo(map);
    }

    function createMarker(addr, isSelected = false) {
      const icon = L.divIcon({
        className: `custom-marker ${isSelected ? "selected-marker" : ""}`,
        iconSize: [24, 24],
        iconAnchor: [12, 12]
      });

      const marker = L.marker([addr.lat, addr.lng], { icon })
        .addTo(map)
        .bindPopup(`
          <div class="p-2">
            <strong>${escapeHtml(addr.address)}</strong><br>
            <span class="text-sm">${escapeHtml(addr.zone || "Sin zona")} - ${escapeHtml(addr.postal_code || "Sin CP")}</span>
          </div>
        `);

      marker.on("click", () => toggleAddressSelection(addr.id));
      return marker;
    }

    function getFilteredAddresses() {
      const zoneFilter = document.getElementById("zone-filter").value;
      const postalFilter = document.getElementById("postal-filter").value;
      const distanceFilter = parseInt(document.getElementById("distance-filter").value, 10);

      let filtered = [...addresses];
      if (zoneFilter) filtered = filtered.filter(a => a.zone === zoneFilter);
      if (postalFilter) filtered = filtered.filter(a => a.postal_code === postalFilter);

      if (distanceFilter < 100 && filtered.length && map) {
        const center = map.getCenter();
        filtered = filtered.filter(a => a.lat && a.lng && getDistanceKm(center.lat, center.lng, a.lat, a.lng) <= distanceFilter);
      }
      return filtered;
    }

    function updateMarkers() {
      Object.values(markers).forEach(m => map.removeLayer(m));
      markers = {};

      const filtered = getFilteredAddresses();
      filtered.forEach(addr => {
        if (addr.lat && addr.lng) markers[addr.id] = createMarker(addr, selectedIds.includes(addr.id));
      });

      const bounds = filtered.filter(a => a.lat && a.lng).map(a => [a.lat, a.lng]);
      if (bounds.length) map.fitBounds(bounds, { padding: [50, 50] });
    }

    function updateFilters() {
      const zones = [...new Set(addresses.map(a => a.zone).filter(Boolean))];
      const postals = [...new Set(addresses.map(a => a.postal_code).filter(Boolean))];

      const zoneSelect = document.getElementById("zone-filter");
      const postalSelect = document.getElementById("postal-filter");

      const currentZone = zoneSelect.value;
      const currentPostal = postalSelect.value;

      zoneSelect.innerHTML = `<option value="">Todas las zonas</option>` +
        zones.map(z => `<option value="${escapeAttr(z)}" ${z===currentZone?"selected":""}>${escapeHtml(z)}</option>`).join("");

      postalSelect.innerHTML = `<option value="">Todos los c√≥digos postales</option>` +
        postals.map(p => `<option value="${escapeAttr(p)}" ${p===currentPostal?"selected":""}>${escapeHtml(p)}</option>`).join("");
    }

    // ========= Selection / order =========
    function toggleAddressSelection(id) {
      const idx = selectedIds.indexOf(id);
      if (idx > -1) {
        selectedIds.splice(idx, 1);
        visitOrderIds = visitOrderIds.filter(x => x !== id);
      } else {
        if (selectedIds.length >= config.maxRoutePoints) {
          showToast(`M√°ximo ${config.maxRoutePoints} puntos intermedios`, "warning");
          return;
        }
        selectedIds.push(id);
        visitOrderIds.push(id);
      }
      updateUI();
      updateMarkers();
    }

    function syncVisitOrderWithSelected() {
      const setSel = new Set(selectedIds);
      visitOrderIds = visitOrderIds.filter(id => setSel.has(id));
      selectedIds.forEach(id => { if (!visitOrderIds.includes(id)) visitOrderIds.push(id); });
    }

    // ========= Start/End =========
    function updateStartEndSelectors() {
      const startSel = document.getElementById("start-select");
      const endSel = document.getElementById("end-select");

      const prevStart = startSel.value;
      const prevEnd = endSel.value;

      startSel.innerHTML = `
        <option value="">Seleccionar...</option>
        <option value="__GEO__">üìç Mi ubicaci√≥n</option>
        <option value="__NEW__">Nueva direcci√≥n...</option>
      `;
      endSel.innerHTML = `
        <option value="">Seleccionar...</option>
        <option value="__GEO__">üìç Mi ubicaci√≥n</option>
        <option value="__NEW__">Nueva direcci√≥n...</option>
      `;

      addresses.forEach(a => {
        startSel.appendChild(new Option(a.address, a.id));
        endSel.appendChild(new Option(a.address, a.id));
      });

      if ([...startSel.options].some(o => o.value === prevStart)) startSel.value = prevStart;
      if ([...endSel.options].some(o => o.value === prevEnd)) endSel.value = prevEnd;

      document.getElementById("start-new").classList.toggle("hidden", startSel.value !== "__NEW__");
      document.getElementById("end-new").classList.toggle("hidden", endSel.value !== "__NEW__");

      const hasSome = selectedIds.length >= 1;
      const hasSE = !!startSel.value && !!endSel.value;
      document.getElementById("optimize-route-btn").disabled = !(hasSome && hasSE);
      document.getElementById("calc-route-btn").disabled = !(hasSome && hasSE);
    }

    async function getBrowserLocationPoint() {
      return new Promise((resolve) => {
        if (!navigator.geolocation) return resolve(null);
        navigator.geolocation.getCurrentPosition(
          (pos) => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude, address: "Mi ubicaci√≥n" }),
          () => resolve(null),
          { enableHighAccuracy: true, timeout: 8000, maximumAge: 60000 }
        );
      });
    }

    function pointFromExisting(id) {
      const a = addresses.find(x => x.id === id);
      if (!a || !a.lat || !a.lng) return null;
      return { lat: a.lat, lng: a.lng, address: a.address };
    }

    async function resolveStartEnd() {
      const startSelVal = document.getElementById("start-select").value;
      const endSelVal = document.getElementById("end-select").value;
      const startNew = document.getElementById("start-new").value.trim();
      const endNew = document.getElementById("end-new").value.trim();

      if (!startSelVal) throw new Error("Eleg√≠ un punto de partida");
      if (!endSelVal) throw new Error("Eleg√≠ un punto de finalizaci√≥n");

      // START
      if (startSelVal === "__GEO__") {
        setLoading(true, "Obteniendo ubicaci√≥n‚Ä¶", "Inicio");
        const p = await getBrowserLocationPoint();
        if (!p) throw new Error("No pude obtener tu ubicaci√≥n (permiso?)");
        startPoint = p;
      } else if (startSelVal === "__NEW__") {
        if (!startNew) throw new Error("Ingres√° direcci√≥n de partida");
        setLoading(true, "Geocodificando‚Ä¶", "Inicio");
        const c = await geocodeAddress(normalizeAddressForGeocode(startNew));
        if (!c) throw new Error("No pude geocodificar el inicio");
        startPoint = { ...c, address: startNew };
      } else {
        const p = pointFromExisting(startSelVal);
        if (!p) throw new Error("Inicio inv√°lido");
        startPoint = p;
      }

      // END
      if (endSelVal === "__GEO__") {
        setLoading(true, "Obteniendo ubicaci√≥n‚Ä¶", "Fin");
        const p = await getBrowserLocationPoint();
        if (!p) throw new Error("No pude obtener tu ubicaci√≥n (permiso?)");
        endPoint = p;
      } else if (endSelVal === "__NEW__") {
        if (!endNew) throw new Error("Ingres√° direcci√≥n de fin");
        setLoading(true, "Geocodificando‚Ä¶", "Fin");
        const c = await geocodeAddress(normalizeAddressForGeocode(endNew));
        if (!c) throw new Error("No pude geocodificar el fin");
        endPoint = { ...c, address: endNew };
      } else {
        const p = pointFromExisting(endSelVal);
        if (!p) throw new Error("Fin inv√°lido");
        endPoint = p;
      }

      return { startPoint, endPoint };
    }

    // ========= OSRM =========
    function toLonLat(points) { return points.map(p => `${p.lng},${p.lat}`).join(";"); }

    async function osrmRouteDriving(orderedPoints) {
      const coords = toLonLat(orderedPoints);
      const url = `https://router.project-osrm.org/route/v1/driving/${coords}?overview=full&geometries=geojson&steps=true`;
      const res = await fetch(url);
      if (!res.ok) throw new Error("OSRM route failed");
      return await res.json();
    }

    async function osrmTableDriving(points) {
      const coords = toLonLat(points);
      const url = `https://router.project-osrm.org/table/v1/driving/${coords}?annotations=duration,distance`;
      const res = await fetch(url);
      if (!res.ok) throw new Error("OSRM table failed");
      return await res.json();
    }

    function solveOptimalPathFixedStartEnd(matrix, startIdx, endIdx, waypointIdxs) {
      const n = waypointIdxs.length;
      if (n === 0) return [startIdx, endIdx];

      const DP = Array.from({ length: 1 << n }, () => Array(n).fill(Infinity));
      const parent = Array.from({ length: 1 << n }, () => Array(n).fill(-1));

      for (let i = 0; i < n; i++) {
        const w = waypointIdxs[i];
        DP[1 << i][i] = matrix[startIdx][w];
      }

      for (let mask = 0; mask < (1 << n); mask++) {
        for (let last = 0; last < n; last++) {
          if (!(mask & (1 << last))) continue;
          const lastIdx = waypointIdxs[last];
          const cost = DP[mask][last];
          if (!isFinite(cost)) continue;

          for (let nxt = 0; nxt < n; nxt++) {
            if (mask & (1 << nxt)) continue;
            const nxtIdx = waypointIdxs[nxt];
            const nmask = mask | (1 << nxt);
            const cand = cost + matrix[lastIdx][nxtIdx];
            if (cand < DP[nmask][nxt]) {
              DP[nmask][nxt] = cand;
              parent[nmask][nxt] = last;
            }
          }
        }
      }

      const full = (1 << n) - 1;
      let bestLast = 0, bestCost = Infinity;

      for (let last = 0; last < n; last++) {
        const lastIdx = waypointIdxs[last];
        const cand = DP[full][last] + matrix[lastIdx][endIdx];
        if (cand < bestCost) { bestCost = cand; bestLast = last; }
      }

      const orderWaypoints = [];
      let mask = full, cur = bestLast;
      while (cur !== -1) {
        orderWaypoints.push(waypointIdxs[cur]);
        const prev = parent[mask][cur];
        mask = mask & ~(1 << cur);
        cur = prev;
      }
      orderWaypoints.reverse();
      return [startIdx, ...orderWaypoints, endIdx];
    }

    function clearRouteLayersOnly() {
      if (routeLayer) { map.removeLayer(routeLayer); routeLayer = null; }
      routeNumberMarkers.forEach(m => map.removeLayer(m));
      routeNumberMarkers = [];
      lastOrderedRoutePoints = null;
      document.getElementById("route-info").classList.add("hidden");
      document.getElementById("export-gpx-btn").disabled = true;
      document.getElementById("export-kml-btn").disabled = true;
    }

    function drawRouteAndMarkers(orderedPoints, geojsonGeometry) {
      clearRouteLayersOnly();
      routeLayer = L.geoJSON(geojsonGeometry, { style: { color: "#6366f1", weight: 4, opacity: 0.95 } }).addTo(map);

      routeNumberMarkers = orderedPoints.map((p, idx) => {
        return L.marker([p.lat, p.lng], {
          icon: L.divIcon({
            className: "route-number-marker",
            html: `<div style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; width: 28px; height: 28px; border-radius: 50%; display:flex; align-items:center; justify-content:center; font-weight:800; font-size:12px; border:2px solid rgba(255,255,255,0.95); box-shadow:0 2px 8px rgba(0,0,0,0.3);">${idx+1}</div>`,
            iconSize: [28, 28],
            iconAnchor: [14, 14]
          })
        }).addTo(map);
      });

      map.fitBounds(orderedPoints.map(p => [p.lat, p.lng]), { padding: [50, 50] });
    }

    function showRouteInfo(orderedPoints, distKm, durMin) {
      lastOrderedRoutePoints = orderedPoints;
      const panel = document.getElementById("route-info");
      const details = document.getElementById("route-details");

      details.innerHTML = `
        <ol class="list-decimal list-inside space-y-1">
          ${orderedPoints.map(p => `<li class="truncate">${escapeHtml(p.address)}</li>`).join("")}
        </ol>
        <div class="mt-3 pt-3 border-t border-slate-600">
          <p class="font-semibold text-emerald-400">Distancia total: ${distKm.toFixed(2)} km</p>
          <p class="text-xs text-slate-400 mt-1">Duraci√≥n total: ${Math.round(durMin)} min</p>
        </div>
      `;
      panel.classList.remove("hidden");
      document.getElementById("export-gpx-btn").disabled = false;
      document.getElementById("export-kml-btn").disabled = false;
    }

    function buildMidpointsFromVisitOrder() {
      syncVisitOrderWithSelected();
      return visitOrderIds
        .map(id => addresses.find(a => a.id === id))
        .filter(Boolean)
        .filter(a => a.lat && a.lng)
        .map(a => ({ lat: a.lat, lng: a.lng, address: a.address, _id: a.id }));
    }

    async function calculateWithUserOrder() {
      const btn = document.getElementById("calc-route-btn");
      try {
        setButtonLoading(btn, true, "Calcular");
        setLoading(true, "Calculando ruta‚Ä¶", "Respetando tu orden");

        await resolveStartEnd();
        const mid = buildMidpointsFromVisitOrder();
        if (!mid.length) throw new Error("No hay puntos intermedios v√°lidos");

        const points = [startPoint, ...mid, endPoint];

        setLoading(true, "Trazando ruta por calles‚Ä¶", "OSRM Route");
        const routeRes = await osrmRouteDriving(points);
        if (!routeRes.routes?.length) throw new Error("OSRM route vac√≠o");

        const route = routeRes.routes[0];
        drawRouteAndMarkers(points, route.geometry);
        showRouteInfo(points, route.distance / 1000, route.duration / 60);

        setLoading(false);
        showToast("Ruta calculada ‚úÖ", "success");
      } catch (e) {
        setLoading(false);
        showToast(e.message || "Error", "error");
      } finally {
        setButtonLoading(btn, false, "Calcular");
      }
    }

    async function optimizeRoute() {
      const btn = document.getElementById("optimize-route-btn");
      try {
        setButtonLoading(btn, true, "Optimizar");
        setLoading(true, "Optimizando recorrido‚Ä¶", "Calculando matriz de tiempos");

        await resolveStartEnd();
        const mid = buildMidpointsFromVisitOrder();
        if (!mid.length) throw new Error("No hay puntos intermedios v√°lidos");

        const points = [startPoint, ...mid, endPoint];

        setLoading(true, "Calculando matriz‚Ä¶", "OSRM Table (durations)");
        const table = await osrmTableDriving(points);
        const durations = table.durations;
        if (!durations) throw new Error("OSRM no devolvi√≥ durations");

        setLoading(true, "Buscando el mejor orden‚Ä¶", "DP exacto (hasta 10 puntos)");
        const startIdx = 0;
        const endIdx = points.length - 1;
        const waypointIdxs = [];
        for (let i = 1; i < points.length - 1; i++) waypointIdxs.push(i);

        const orderIdxs = solveOptimalPathFixedStartEnd(durations, startIdx, endIdx, waypointIdxs);
        const orderedPoints = orderIdxs.map(i => points[i]);

        // reflect order back to UI (best-effort)
        const optimizedMid = orderedPoints.slice(1, -1);
        visitOrderIds = optimizedMid
          .map(p => addresses.find(a => a.address === p.address && a.lat === p.lat && a.lng === p.lng)?._id)
          .filter(Boolean);

        setLoading(true, "Trazando ruta final‚Ä¶", "OSRM Route");
        const routeRes = await osrmRouteDriving(orderedPoints);
        if (!routeRes.routes?.length) throw new Error("OSRM route vac√≠o");

        const route = routeRes.routes[0];
        drawRouteAndMarkers(orderedPoints, route.geometry);
        showRouteInfo(orderedPoints, route.distance / 1000, route.duration / 60);

        updateUI();

        setLoading(false);
        showToast("Ruta optimizada ‚úÖ", "success");
      } catch (e) {
        setLoading(false);
        showToast(e.message || "Error", "error");
      } finally {
        setButtonLoading(btn, false, "Optimizar");
      }
    }

    // ========= Export placeholders =========
    function exportGPX() { showToast("GPX: lo activamos en el siguiente paso.", "info"); }
    function exportKML() { showToast("KML: lo activamos en el siguiente paso.", "info"); }

    // ========= Address list render =========
    function renderAddressList() {
      const container = document.getElementById("address-list");
      const filtered = getFilteredAddresses();

      if (!filtered.length) {
        container.innerHTML = `<div class="text-center py-6 text-slate-500">
          <p>${addresses.length ? "No hay resultados con los filtros actuales" : "No hay direcciones cargadas"}</p>
        </div>`;
        return;
      }

      container.innerHTML = filtered.map(addr => {
        const isSelected = selectedIds.includes(addr.id);
        const orderNum = visitOrderIds.indexOf(addr.id) + 1;
        return `
          <div class="address-card bg-slate-700/40 rounded-xl p-3 cursor-pointer transition-all border-2 ${isSelected ? "border-indigo-500" : "border-transparent"}"
               data-id="${escapeAttr(addr.id)}">
            <div class="flex items-start gap-3">
              <div class="w-8 h-8 rounded-lg ${isSelected ? "bg-indigo-500" : "bg-slate-600"} flex items-center justify-center flex-shrink-0">
                ${isSelected ? `<span class="font-bold text-sm">${orderNum || ""}</span>` : "üìç"}
              </div>
              <div class="flex-1 min-w-0">
                <p class="font-medium text-sm truncate">${escapeHtml(addr.address)}</p>
                <p class="text-xs text-slate-400 mt-1">${escapeHtml(addr.zone || "Sin zona")} ‚Ä¢ ${escapeHtml(addr.postal_code || "Sin CP")}</p>
              </div>
              <button class="delete-btn p-1.5 rounded-lg hover:bg-slate-600 transition-all opacity-70 hover:opacity-100" data-del="${escapeAttr(addr.id)}" title="Eliminar">üóëÔ∏è</button>
            </div>
          </div>
        `;
      }).join("");

      container.querySelectorAll(".address-card").forEach(card => {
        const id = card.getAttribute("data-id");
        card.addEventListener("click", (e) => {
          if (e.target.closest(".delete-btn")) return;
          toggleAddressSelection(id);
        });
      });

      container.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          showDeleteModal(btn.getAttribute("data-del"));
        });
      });
    }

    // ========= Route order render =========
    function renderRouteOrder() {
      const box = document.getElementById("route-order");
      syncVisitOrderWithSelected();

      if (!visitOrderIds.length) {
        box.innerHTML = `<p class="text-xs text-slate-500">Seleccion√° direcciones para armar el orden ac√°.</p>`;
        return;
      }

      box.innerHTML = visitOrderIds.map((id, idx) => {
        const a = addresses.find(x => x.id === id);
        if (!a) return "";
        return `
          <div class="bg-slate-900/30 border border-slate-700 rounded-xl p-2 flex items-center gap-2"
               draggable="true" data-dnd="${escapeAttr(id)}">
            <div class="w-7 h-7 rounded-lg bg-indigo-500/20 text-indigo-300 flex items-center justify-center font-bold text-xs">${idx+1}</div>
            <div class="flex-1 min-w-0">
              <div class="text-sm truncate">${escapeHtml(a.address)}</div>
              <div class="text-xs text-slate-400 truncate">${escapeHtml(a.zone || "‚Äî")} ‚Ä¢ ${escapeHtml(a.postal_code || "‚Äî")}</div>
            </div>
            <div class="text-slate-400 cursor-grab select-none" title="Arrastrar">‚†ø</div>
          </div>
        `;
      }).join("");

      let draggingId = null;
      box.querySelectorAll("[data-dnd]").forEach(el => {
        el.addEventListener("dragstart", () => { draggingId = el.getAttribute("data-dnd"); el.classList.add("dragging"); });
        el.addEventListener("dragend", () => {
          draggingId = null;
          el.classList.remove("dragging");
          box.querySelectorAll("[data-dnd]").forEach(x => x.classList.remove("drop-hint"));
        });

        el.addEventListener("dragover", (e) => { e.preventDefault(); el.classList.add("drop-hint"); });
        el.addEventListener("dragleave", () => el.classList.remove("drop-hint"));

        el.addEventListener("drop", (e) => {
          e.preventDefault();
          el.classList.remove("drop-hint");
          const targetId = el.getAttribute("data-dnd");
          if (!draggingId || draggingId === targetId) return;

          const from = visitOrderIds.indexOf(draggingId);
          const to = visitOrderIds.indexOf(targetId);
          if (from < 0 || to < 0) return;

          const [moved] = visitOrderIds.splice(from, 1);
          visitOrderIds.splice(to, 0, moved);

          renderRouteOrder();
          updateUI();
        });
      });
    }

    // ========= Delete =========
    function showDeleteModal(id) {
      deleteTargetId = id;
      const addr = addresses.find(a => a.id === id);
      document.getElementById("delete-address-text").textContent = addr ? addr.address : "Esta direcci√≥n";
      document.getElementById("delete-modal").classList.remove("hidden");
    }
    function hideDeleteModal() {
      deleteTargetId = null;
      document.getElementById("delete-modal").classList.add("hidden");
    }
    function deleteAddress() {
      if (!deleteTargetId) return;
      const id = deleteTargetId;

      addresses = addresses.filter(a => a.id !== id);
      selectedIds = selectedIds.filter(x => x !== id);
      visitOrderIds = visitOrderIds.filter(x => x !== id);

      hideDeleteModal();
      saveState();
      updateFilters();
      updateUI();
      updateMarkers();
      showToast("Direcci√≥n eliminada ‚úÖ", "success");
    }

    // ========= Add address =========
    async function handleFormSubmit(e) {
      e.preventDefault();
      if (addresses.length >= config.maxAddresses) return showToast("L√≠mite alcanzado", "warning");

      const addressInput = document.getElementById("address-input");
      const zoneInput = document.getElementById("zone-input");
      const postalInput = document.getElementById("postal-input");

      const address = addressInput.value.trim();
      if (!address) return showToast("Ingres√° una direcci√≥n", "warning");

      setLoading(true, "Geocodificando‚Ä¶", address);
      const coords = await geocodeAddress(normalizeAddressForGeocode(address));
      if (!coords) { setLoading(false); return showToast("No pude geocodificar", "error"); }

      const id = (crypto.randomUUID ? crypto.randomUUID() : (Date.now().toString() + Math.random().toString(16).slice(2)));
      addresses.push({
        id,
        address,
        zone: zoneInput.value.trim() || "",
        postal_code: postalInput.value.trim() || "",
        lat: coords.lat,
        lng: coords.lng,
        created_at: new Date().toISOString()
      });

      addressInput.value = "";
      zoneInput.value = "";
      postalInput.value = "";

      saveState();
      updateFilters();
      updateUI();
      updateMarkers();
      setLoading(false);
      showToast("Direcci√≥n agregada ‚úÖ", "success");
    }

    // ========= Import =========
    function setupImportHandlers() {
      const toggleBtn = document.getElementById("toggle-import-form");
      const importSection = document.getElementById("import-form-section");
      const dropZone = document.getElementById("drop-zone");
      const fileInput = document.getElementById("file-input");
      const cancelBtn = document.getElementById("cancel-import-btn");

      toggleBtn.addEventListener("click", () => {
        importSection.classList.toggle("hidden");
        if (!importSection.classList.contains("hidden")) {
          fileInput.value = "";
          document.getElementById("file-preview").classList.add("hidden");
          importedData = null;
        }
      });

      dropZone.addEventListener("click", () => fileInput.click());

      ["dragenter","dragover","dragleave","drop"].forEach(name => {
        dropZone.addEventListener(name, (e) => { e.preventDefault(); e.stopPropagation(); });
      });

      dropZone.addEventListener("drop", (e) => {
        const files = e.dataTransfer.files;
        if (files && files.length) { fileInput.files = files; handleFileSelect(files[0]); }
      });

      fileInput.addEventListener("change", (e) => {
        if (e.target.files && e.target.files.length) handleFileSelect(e.target.files[0]);
      });

      document.getElementById("import-btn").addEventListener("click", processImport);

      cancelBtn.addEventListener("click", () => {
        importSection.classList.add("hidden");
        fileInput.value = "";
        document.getElementById("file-preview").classList.add("hidden");
        importedData = null;
      });
    }

    function parseCSV(text) {
      const raw = text.trim();
      if (!raw) return [];
      const lines = raw.split(/\r?\n/);
      if (lines.length < 2) return [];
      const delimiter = (lines[0].includes(";") && !lines[0].includes(",")) ? ";" : ",";
      const headers = lines[0].split(delimiter).map(h => h.trim()).filter(Boolean);
      const out = [];
      for (let i = 1; i < lines.length; i++) {
        const row = {};
        const values = lines[i].split(delimiter).map(v => v.trim());
        headers.forEach((h, idx) => row[h] = values[idx] ?? "");
        out.push(row);
      }
      return out;
    }

    function parseXLSX(arrayBuffer) {
      const wb = XLSX.read(arrayBuffer, { type: "array" });
      const ws = wb.Sheets[wb.SheetNames[0]];
      return XLSX.utils.sheet_to_json(ws, { defval: "" });
    }

    function populateColumnSelectors(data) {
      const headers = Object.keys(data[0] || {});
      const addressSel = document.getElementById("address-column");
      const zoneSel = document.getElementById("zone-column");
      const postalSel = document.getElementById("postal-column");

      addressSel.innerHTML = `<option value="">Columna Direcci√≥n</option>`;
      zoneSel.innerHTML = `<option value="">Columna Zona (opcional)</option>`;
      postalSel.innerHTML = `<option value="">Columna C√≥digo Postal (opcional)</option>`;

      headers.forEach(h => {
        addressSel.appendChild(new Option(h, h));
        zoneSel.appendChild(new Option(h, h));
        postalSel.appendChild(new Option(h, h));
        const low = h.toLowerCase();
        if (low.includes("direcci√≥n") || low.includes("direccion") || low.includes("address") || low.includes("indirizzo")) addressSel.value = h;
        if (low.includes("zona") || low.includes("zone") || low.includes("quartiere")) zoneSel.value = h;
        if (low.includes("postal") || low.includes("codigo") || low.includes("zip") || low.includes("cap")) postalSel.value = h;
      });
    }

    function handleFileSelect(file) {
      document.getElementById("file-name").textContent = file.name;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          let data = [];
          const name = file.name.toLowerCase();
          if (name.endsWith(".csv")) data = parseCSV(e.target.result);
          else if (name.endsWith(".xlsx") || name.endsWith(".xls")) data = parseXLSX(e.target.result);
          else return showToast("Formato no soportado", "error");

          if (!data.length) return showToast("No hay datos", "error");
          importedData = data;
          populateColumnSelectors(data);
          document.getElementById("file-preview").classList.remove("hidden");
        } catch {
          showToast("Error leyendo archivo", "error");
        }
      };
      if (file.name.toLowerCase().endsWith(".csv")) reader.readAsText(file);
      else reader.readAsArrayBuffer(file);
    }

    async function processImport() {
      if (!importedData?.length) return showToast("No hay datos", "warning");

      const addressCol = document.getElementById("address-column").value;
      const zoneCol = document.getElementById("zone-column").value;
      const postalCol = document.getElementById("postal-column").value;
      if (!addressCol) return showToast("Eleg√≠ columna Direcci√≥n", "warning");

      if (addresses.length + importedData.length > config.maxAddresses)
        return showToast(`Solo pod√©s agregar ${config.maxAddresses - addresses.length} m√°s`, "warning");

      const importBtn = document.getElementById("import-btn");
      importBtn.disabled = true;

      let ok = 0, err = 0;

      for (let i = 0; i < importedData.length; i++) {
        const row = importedData[i];
        const addr = (row[addressCol] ?? "").toString().trim();
        if (!addr) continue;

        setLoading(true, `Importando ${i+1}/${importedData.length}‚Ä¶`, addr);

        const coords = await geocodeAddress(normalizeAddressForGeocode(addr));
        if (!coords) { err++; await sleep(config.importGeocodeDelayMs); continue; }

        const id = (crypto.randomUUID ? crypto.randomUUID() : (Date.now().toString() + Math.random().toString(16).slice(2)));
        addresses.push({
          id,
          address: addr,
          zone: zoneCol ? (row[zoneCol] ?? "").toString().trim() : "",
          postal_code: postalCol ? (row[postalCol] ?? "").toString().trim() : "",
          lat: coords.lat,
          lng: coords.lng,
          created_at: new Date().toISOString()
        });

        ok++;
        await sleep(config.importGeocodeDelayMs);
      }

      importBtn.disabled = false;
      setLoading(false);

      document.getElementById("import-form-section").classList.add("hidden");
      document.getElementById("file-input").value = "";
      document.getElementById("file-preview").classList.add("hidden");
      importedData = null;

      saveState();
      updateFilters();
      updateUI();
      updateMarkers();

      showToast(`Import: ${ok} ok${err ? ` ‚Ä¢ ${err} errores` : ""}`, ok ? "success" : "error");
    }

    // ========= Backup / Restore / Clear =========
    function downloadBackupJson() {
      const payload = { exported_at: new Date().toISOString(), addresses };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "route_planner_backup.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      showToast("Backup descargado ‚úÖ", "success");
    }

    function clearAll() {
      if (!confirm("¬øBorrar todas las direcciones guardadas?")) return;
      addresses = [];
      selectedIds = [];
      visitOrderIds = [];
      clearRouteLayersOnly();
      localStorage.removeItem(config.storageKey);
      updateFilters();
      updateUI();
      updateMarkers();
      showToast("Todo limpio ‚úÖ", "success");
    }

    function restoreBackupFromFile(file) {
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const parsed = JSON.parse(reader.result);
          if (!Array.isArray(parsed?.addresses)) throw new Error();
          addresses = parsed.addresses;
          selectedIds = [];
          visitOrderIds = [];
          clearRouteLayersOnly();
          saveState();
          updateFilters();
          updateUI();
          updateMarkers();
          showToast("Backup restaurado ‚úÖ", "success");
        } catch {
          showToast("JSON inv√°lido", "error");
        }
      };
      reader.readAsText(file);
    }

    // ========= Autocomplete =========
    function debounce(fn, delay) { let t=null; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),delay);} }

    function hideSuggestions(kind) {
      const el = kind === "address" ? document.getElementById("address-suggestions")
               : kind === "start" ? document.getElementById("start-suggestions")
               : document.getElementById("end-suggestions");
      el.classList.add("hidden");
      el.innerHTML = "";
    }

    function showSuggestions(kind, items, inputEl) {
      const el = kind === "address" ? document.getElementById("address-suggestions")
               : kind === "start" ? document.getElementById("start-suggestions")
               : document.getElementById("end-suggestions");
      if (!items.length) return hideSuggestions(kind);

      el.innerHTML = items.map(it => `
        <button type="button" class="text-slate-200">
          <div class="text-sm">${escapeHtml(it.label)}</div>
          <div class="text-xs text-slate-400 mono">${it.lat.toFixed(5)}, ${it.lng.toFixed(5)}</div>
        </button>
      `).join("");

      [...el.querySelectorAll("button")].forEach((btn, idx) => {
        btn.addEventListener("click", () => { inputEl.value = items[idx].label; hideSuggestions(kind); });
      });

      el.classList.remove("hidden");
    }

    const handleAutocompleteAddress = debounce(async () => {
      const input = document.getElementById("address-input");
      const q = input.value.trim();
      if (q.length < 3) return hideSuggestions("address");
      const items = await searchAutocomplete(normalizeAddressForGeocode(q));
      showSuggestions("address", items, input);
    }, config.autocompleteDelayMs);

    // ========= UI =========
    function updateUI() {
      document.getElementById("address-count").textContent = `${addresses.length} direccion${addresses.length !== 1 ? "es" : ""}`;
      document.getElementById("selected-count").textContent = `${selectedIds.length}/${config.maxRoutePoints}`;
      updateStartEndSelectors();
      renderAddressList();
      renderRouteOrder();
    }

    // ========= Mobile Sidebar controls (FIX) =========
    function setupMobileSidebar() {
      const sidebar = document.getElementById("sidebar");
      const backdrop = document.getElementById("sidebar-backdrop");
      const toggleBtn = document.getElementById("toggle-panel");

      function openSidebar() {
        sidebar.classList.remove("-translate-x-full");
        backdrop.classList.remove("hidden");
      }
      function closeSidebar() {
        sidebar.classList.add("-translate-x-full");
        backdrop.classList.add("hidden");
      }
      function isSidebarOpen() {
        return !sidebar.classList.contains("-translate-x-full");
      }

      toggleBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        if (isSidebarOpen()) closeSidebar();
        else openSidebar();
      });

      backdrop.addEventListener("click", closeSidebar);

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeSidebar();
      });

      // Only close when map is clicked AND sidebar is open
      document.getElementById("map").addEventListener("click", () => {
        if (window.innerWidth < 1024 && isSidebarOpen()) closeSidebar();
      });

      // Optional: auto-close sidebar after selecting an address in mobile
      // (coment√° si no te gusta)
      const closeOnMobile = () => {
        if (window.innerWidth < 1024 && isSidebarOpen()) closeSidebar();
      };
      // Hook into selection by listening for toast container (simple)
      // We'll call closeOnMobile manually where we want; not mandatory
      window.__closeSidebarMobile = closeOnMobile;
    }

    // ========= Init =========
    function init() {
      loadGeocodeCache();
      loadState();
      initMap();
      updateFilters();
      updateUI();
      updateMarkers();

      setupMobileSidebar();

      document.getElementById("address-form").addEventListener("submit", handleFormSubmit);
      document.getElementById("address-input").addEventListener("input", handleAutocompleteAddress);
      document.getElementById("address-input").addEventListener("blur", () => setTimeout(() => hideSuggestions("address"), 180));

      document.getElementById("start-select").addEventListener("change", updateStartEndSelectors);
      document.getElementById("end-select").addEventListener("change", updateStartEndSelectors);

      document.getElementById("zone-filter").addEventListener("change", () => { updateUI(); updateMarkers(); });
      document.getElementById("postal-filter").addEventListener("change", () => { updateUI(); updateMarkers(); });
      document.getElementById("distance-filter").addEventListener("input", (e) => {
        document.getElementById("distance-value").textContent = e.target.value;
        updateUI(); updateMarkers();
      });
      document.getElementById("reset-filters").addEventListener("click", () => {
        document.getElementById("zone-filter").value = "";
        document.getElementById("postal-filter").value = "";
        document.getElementById("distance-filter").value = "50";
        document.getElementById("distance-value").textContent = "50";
        updateUI(); updateMarkers();
      });

      setupImportHandlers();

      document.getElementById("calc-route-btn").addEventListener("click", calculateWithUserOrder);
      document.getElementById("optimize-route-btn").addEventListener("click", optimizeRoute);
      document.getElementById("clear-route-btn").addEventListener("click", () => {
        selectedIds = [];
        visitOrderIds = [];
        clearRouteLayersOnly();
        updateUI(); updateMarkers();
        showToast("Selecci√≥n y ruta limpiadas", "info");
      });

      document.getElementById("export-gpx-btn").addEventListener("click", exportGPX);
      document.getElementById("export-kml-btn").addEventListener("click", exportKML);

      document.getElementById("backup-btn").addEventListener("click", downloadBackupJson);
      document.getElementById("clear-all-btn").addEventListener("click", clearAll);
      document.getElementById("restore-input").addEventListener("change", (e) => {
        const f = e.target.files?.[0];
        if (f) restoreBackupFromFile(f);
        e.target.value = "";
      });

      document.getElementById("cancel-delete").addEventListener("click", hideDeleteModal);
      document.getElementById("confirm-delete").addEventListener("click", deleteAddress);

      showToast("Mobile FIX ‚úÖ men√∫ + panel scroll", "success");
    }

    init();
  </script>
</body>
</html>
